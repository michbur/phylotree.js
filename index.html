<!DOCTYPE html>
<html lang = 'en'>

<head>
    <meta charset="utf-8">
    <!-- Latest compiled and minified CSS -->
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>


    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <!-- Optional theme -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">-->

    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="phylotree.js"></script>

    <link href="phylotree.css" rel="stylesheet">
    
    <style>
    
        .fa-rotate-45 {
          -webkit-transform: rotate(45deg);
          -moz-transform: rotate(45deg);
          -ms-transform: rotate(45deg);
          -o-transform: rotate(45deg);
          transform: rotate(45deg);
        }

        .fa-rotate-135 {
          -webkit-transform: rotate(135deg);
          -moz-transform: rotate(135deg);
          -ms-transform: rotate(135deg);
          -o-transform: rotate(135deg);
          transform: rotate(135deg);
        }

   </style>
</head>

<body style = 'padding-top: 70px;'>

<!--
###############################################################################################################################
-->

<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://github.com/veg/phylotree.js/tree/master">phylotree.js</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      
      
        <div class="form-group navbar-form navbar-right">
          <input type="text" id = 'branch_filter' class="form-control" placeholder="Filter branches on">
        </div>
            
      
      <div class="row">
        <div class="col-md-5 navbar-right ">
            <div class="navbar-form " role="search">
                 <div class="input-group">
                    <span class="input-group-btn">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                            Tag <span class="caret"></span>
                        </button>
                          <ul class="dropdown-menu" id = "selection_name_dropdown">
                            <li id = "selection_new"><a href="#">New selection set</a></li>
                            <li id = "selection_delete" class = "disabled"><a href="#">Delete selection set</a></li>
                            <li id = "selection_rename"><a href="#">Rename selection set</a></li>
                            <li class="divider"></li>
                         </ul>
                    </span>

                    <input type="text" class="form-control" value = "Foreground" id = "selection_name_box" disabled>               
                    
                    <span class="input-group-btn" id = "save_selection_name" style = "display: none" >
                        <button type="button" class="btn btn-default" id = "cancel_selection_button" >
                            Cancel
                        </button>
                        <button type="button" class="btn btn-default" id = "save_selection_button">
                            Save
                        </button>
                    </span>
                    <span class="input-group-btn">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Selection <span class="caret"></span></button>
                          <ul class="dropdown-menu">
                            <li><a href="#" id = "filter_add">Add filtered nodes to selection</a></li>
                            <li><a href="#" id = "filter_remove">Remove filtered nodes from selection</a></li>
                            <li class="divider"></li>
                            <li><a href="#" id = "select_all">Select all</a></li>
                            <li><a href="#" id = "select_all_internal">Select all internal nodes</a></li>
                            <li><a href="#" id = "select_all_leaves">Select all leaf nodes</a></li>
                            <li><a href="#" id = "clear_internal">Clear all internal nodes</a></li>
                            <li><a href="#" id = "clear_leaves">Clear all leaves</a></li>
                            <li><a href="#" id = "select_none">Clear selection</a></li>
                            <li class="divider"></li>
                            <li><a href="#" id = "mp_label">Label internal nodes using maximum parsimony</a></li>
                            <li><a href="#" id = "and_label">Label internal nodes using conjunction (AND) </a></li>
                            <li><a href="#" id = "or_label">Label internal nodes using disjunction (OR) </a></li>
                         </ul>
                    </span>
                  </div>
            </div>
        </div>
    </div>
      
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<div class="modal" id = 'newick_modal'>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Newick string to render</h4>
      </div>
      <div class="modal-body" id = 'newick_body'>
         <textarea id = 'nwk_spec' autofocus = true placeholder = "" style = 'width: 100%; height: 100%' rows = 20 selectionStart = 1 selectionEnd = 1000>(a : 0.1, (b : 0.11, (c : 0.12, d : 0.13) : 0.14) : 0.15)</textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id = 'validate_newick'>Display this tree</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal" id = 'newick_export_modal'>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body" id = 'newick_body'>
         <textarea id = 'nwk_export_spec' autofocus = true placeholder = "" style = 'width: 100%; height: 100%' rows = 20></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class = 'container' id = "main_display">
        
    <div class = 'row'>
        <div class = 'col-md-12'>
            <div class="btn-toolbar" role="toolbar">
              <div class="btn-group">
                <button type="button" class="btn btn-default btn-sm" data-direction = 'vertical' data-amount = '1' title = "Expand vertical spacing">
                    <i class="fa fa-arrows-v" ></i>
                </button>
                 <button type="button" class="btn btn-default btn-sm" data-direction = 'vertical' data-amount = '-1' title = "Compress vertical spacing">
                    <i class="fa  fa-compress fa-rotate-135" ></i>
                </button>
                <button type="button" class="btn btn-default btn-sm" data-direction = 'horizontal' data-amount = '1' title = "Expand horizonal spacing">
                    <i class="fa fa-arrows-h" ></i>
                </button>
                 <button type="button" class="btn btn-default btn-sm" data-direction = 'horizontal' data-amount = '-1' title = "Compress horizonal spacing">
                    <i class="fa  fa-compress fa-rotate-45" ></i>
                </button>
                 <button type="button" class="btn btn-default btn-sm" id = "sort_ascending" title = "Sort deepest clades to the bototm">
                    <i class="fa fa-sort-amount-asc" ></i>
                </button>
                 <button type="button" class="btn btn-default btn-sm" id = "sort_descending" title = "Sort deepsest clades to the top">
                    <i class="fa fa-sort-amount-desc" ></i>
                </button>
                 <button type="button" class="btn btn-default btn-sm" id = "sort_original" title = "Restore original order">
                    <i class="fa fa-sort" ></i>
                </button>
              </div>
            <div class="btn-group" data-toggle="buttons">
              <label class="btn btn-default active btn-sm">
                <input type="radio" name="options" class = "phylotree-layout-mode" data-mode = "linear" autocomplete="off" checked title = "Layout left-to-right"> Linear
              </label>
              <label class="btn btn-default  btn-sm">
                <input type="radio" name="options" class = "phylotree-layout-mode" data-mode = "radial" autocomplete="off" title = "Layout radially"> Radial
              </label>
            </div>
            <div class="btn-group" data-toggle="buttons">
              <label class="btn btn-default  btn-sm">
                <input type="radio" name="options" class = "phylotree-layout-animation" data-mode = "radial" autocomplete="off" title = "Animations off" checked> Animation
              </label>
            </div>
            
            <div class="btn-group" data-toggle="buttons">
              <label class="btn btn-default active btn-sm">
                <input type="radio" class = "phylotree-align-toggler" data-align = "left" name="options-align" autocomplete="off" checked title = "Align tips labels to branches"> 
                    <i class="fa fa-align-left" ></i>
                </input>
                
              </label>
              <label class="btn btn-default btn-sm">
               <input type="radio" class = "phylotree-align-toggler" data-align = "right" name="options-align" autocomplete="off" title = "Align tips labels to the edge of the plot"> 
                    <i class="fa fa-align-right" ></i>
                </input>
              </label>
            </div>
            
            <label class = "pull-right">Selected <span class="badge" id = "selected_branch_counter">0</span> and filtered <span class="badge" id = "selected_filtered_counter">0</span> branches</label>
           
           </div>
        </div>
    </div>
        
    <div class = 'row'>
        <div class = 'col-md-12'>
            <div id = 'tree_container' class = 'tree-widget'>
            </div>
        </div>
    </div>
</div>

<!--
###############################################################################################################################
-->

<script>


$('#newick_export_modal').on('show.bs.modal', function (e) {
    $('textarea[id$="nwk_export_spec"]').val(
        tree.get_newick (
            function (node) {
                var tags = [];
                selection_set.forEach (function (d) { if (node[d]) {tags.push(d)}; });
                if (tags.length) {
                    return "{" + tags.join (",") + "}";
                }
                return "";
            }  
        )
    );
})

$("#newick_file").on ("change", function (e) {
    var files = e.target.files; // FileList object

    if (files.length == 1) {
      var f = files[0];
      var reader = new FileReader();

      reader.onload = (function(theFile) {
        return function(e) {
            var res = d3.layout.newick_parser (e.target.result);
            
            if (res["json"]) {
                if (!("children" in res["json"])) {
                    res["error"] = "Empty tree";
                } 
            }
            
            var warning_div = d3.select ("#main_display").insert ("div", ":first-child");
            if (res["error"]) {
                warning_div.attr ("class", "alert alert-danger alert-dismissable")
                            .html ("<strong>Newick parser error for file " + f.name +": </strong> In file " + res["error"]);

            } else {
                default_tree_settings ();
                tree (res).svg (svg).layout();
                warning_div.attr ("class", "alert alert-success alert-dismissable")
                            .html ("Loaded a tree from  file <strong>" + f.name +": </strong>");
            }          
            warning_div.append ("button")
                       .attr ("type", "button")
                       .attr ("class", "close")
                       .attr ("data-dismiss", "alert")
                       .attr ("aria-hidden", "true")
                       .html ("&times;");
        };
      })(f);

      reader.readAsText(f);
    }
});




$("#display_tree").on ("click", function (e) {
    tree.options ({'branches' : 'straight'}, true);
});

$("#mp_label").on ("click", function (e) {
    tree.max_parsimony (true);
});

$ ("[data-direction]").on ("click", function (e) {
    var which_function = $(this).data ("direction") == 'vertical' ? tree.spacing_x : tree.spacing_y;
    which_function (which_function () + (+ $(this).data ("amount"))).update();
}); 




$(".phylotree-layout-mode").on ("change", function (e) {
    if ($(this).is(':checked')) {
        if (tree.radial () != ($(this).data ("mode") == "radial")) {
            tree.radial (!tree.radial ()).placenodes().update ();
        }
    }
});

$(".phylotree-align-toggler").on ("change", function (e) {
    if ($(this).is(':checked')) {
        if (tree.align_tips ($(this).data ("align") == "right")) {
            tree.placenodes().update ();
        }
    }
});





function sort_nodes (asc) {
    tree.traverse_and_compute (function (n) {
            var d = 1;
            if (n.children && n.children.length) {
                d += d3.max (n.children, function (d) { return d["count_depth"];});
            }
            n["count_depth"] = d;
        }); 
        tree.resort_children (function (a,b) {
            return (a["count_depth"] - b["count_depth"]) * (asc ? 1 : -1);
        });
}

$("#sort_original").on ("click", function (e) {
    tree.resort_children (function (a,b) {
        return a["original_child_order"] - b["original_child_order"];
    });
});

$("#sort_ascending").on ("click", function (e) {
    sort_nodes (true);
});

$("#sort_descending").on ("click", function (e) {
    sort_nodes (false);
});

$("#and_label").on ("click", function (e) {
    tree.internal_label (function (d) { return d.reduce (function (prev, curr) { return curr[current_selection_name] && prev; }, true)}, true);
});

$("#or_label").on ("click", function (e) {
    tree.internal_label (function (d) { return d.reduce (function (prev, curr) { return curr[current_selection_name] || prev; }, false)}, true);
});


$("#filter_add").on ("click", function (e) {
    tree.modify_selection (function (d) { return d.tag || d[current_selection_name];}, current_selection_name, false, true)
        .modify_selection (function (d) { return false; }, "tag", false, false);
});

$("#filter_remove").on ("click", function (e) {
    tree.modify_selection (function (d) { return !d.tag;});
});

$("#select_all").on ("click", function (e) {
    tree.modify_selection (function (d) { return true;});
});

$("#select_all_internal").on ("click", function (e) {
    tree.modify_selection (function (d) { return !d3_phylotree_is_leafnode (d.target);});
});

$("#select_all_leaves").on ("click", function (e) {
    tree.modify_selection (function (d) { return d3_phylotree_is_leafnode (d.target);});
});


$("#select_none").on ("click", function (e) {
    tree.modify_selection (function (d) { return false;});
});

$("#clear_internal").on ("click", function (e) {
    tree.modify_selection (function (d) { return d3_phylotree_is_leafnode (d.target) ? d.target[current_selection_name] : false;});
});

$("#clear_leaves").on ("click", function (e) {
    tree.modify_selection (function (d) { return !d3_phylotree_is_leafnode (d.target) ? d.target[current_selection_name] : false;});
});


$("#display_dengrogram").on ("click", function (e) {
    tree.options ({'branches' : 'step'}, true);
});

//    phylotree.modify_selection = function (callback, attr, place, skip_refresh, mode) {


$("#branch_filter").on ("input propertychange", function (e) {  
   var filter_value = $(this).val();
   
   var rx = new RegExp (filter_value,"i");
   
  tree.modify_selection (function (n) { 
    return filter_value.length && (tree.branch_name () (n.target).search (rx)) != -1; 
   },"tag");
      
});

$("#validate_newick").on ("click", function (e) {
    var res = d3.layout.newick_parser ( $('textarea[id$="nwk_spec"]').val(), true);
    if (res["error"] || ! res["json"]) {
        var warning_div = d3.select ("#newick_body").selectAll ("div  .alert-danger").data ([res["error"]])
        warning_div.enter ().append ("div");
        warning_div.html (function (d) {return d;}).attr ("class", "alert-danger");
        
    } else {
        default_tree_settings ();
         tree (res).svg (svg).layout();
        $('#newick_modal').modal('hide');
    }
});

function default_tree_settings () {
    tree.branch_length (null);
    tree.branch_name (null);
    tree.node_span ('equal');
    tree.options ({'draw-size-bubbles' : false}, false);
    //tree.radial (true);
    tree.style_nodes (node_colorizer);
    tree.style_edges (edge_colorizer);
    tree.selection_label (current_selection_name);
}

function node_colorizer (element, data) {
   try{
   var count_class = 0;
       
    selection_set.forEach (function (d,i) { if (data[d]) {count_class ++; element.style ("fill", color_scheme(i), i == current_selection_id ?  "important" : null);}});
   
    if (count_class > 1) {
    
    } else {
        if (count_class == 0) {        
            element.style ("fill", null);
       }
    }
} 
catch (e) {

}

}

function edge_colorizer (element, data) {
   //console.log (data[current_selection_name]);
try {
    var count_class = 0;
       
    selection_set.forEach (function (d,i) { if (data[d]) {count_class ++; element.style ("stroke", color_scheme(i), i == current_selection_id ?  "important" : null);}});
   
    if (count_class > 1) {
        element.classed ("branch-multiple", true);
    } else 
    if (count_class == 0) {        
             element.style ("stroke", null)
                   .classed ("branch-multiple", false);
    }
} 
catch (e) {
}
    
}

var valid_id = new RegExp ("^[\\w]+$");

$("#selection_name_box").on ("input propertychange", function (e) {  
   var name = $(this).val();         
   
   var accept_name = (selection_set.indexOf (name) < 0) &&
                     valid_id.exec (name) ;
                     
   d3.select ("#save_selection_button").classed ("disabled", accept_name ? null : true ); 
});

$("#selection_rename > a").on ("click", function (e) {

    d3.select ("#save_selection_button")
           .classed ("disabled",true)
           .on ("click", function (e) { // save selection handler
                var old_selection_name = current_selection_name;
                selection_set[current_selection_id] = current_selection_name = $("#selection_name_box").val();
                 
                if (old_selection_name != current_selection_name) {
                    tree.update_key_name (old_selection_name, current_selection_name);
                    update_selection_names (current_selection_id);
                }
                send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                             {'detail' : ['save', this]}));
           });
      
    d3.select ("#cancel_selection_button")
               .classed ("disabled",false)
               .on ("click", function (e) { // save selection handler
                    $("#selection_name_box").val(current_selection_name);
                    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['cancel', this]}));
              });

    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['rename', this]}));
    e.preventDefault    (); 
});

$("#selection_delete > a").on ("click", function (e) {
    
    tree.update_key_name (selection_set[current_selection_id], null)
    selection_set.splice (current_selection_id, 1);
    
    if (current_selection_id > 0) {
        current_selection_id --;
    }
    current_selection_name = selection_set[current_selection_id];
    update_selection_names (current_selection_id)
    $("#selection_name_box").val(current_selection_name)
    
                            
    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['save', this]}));
    e.preventDefault    ();
       
});  
   
$("#selection_new > a").on ("click", function (e) {
    
    d3.select ("#save_selection_button")
               .classed ("disabled",true)
               .on ("click", function (e) { // save selection handler
                    current_selection_name = $("#selection_name_box").val();
                    current_selection_id = selection_set.length;
                    selection_set.push (current_selection_name);
                    update_selection_names (current_selection_id);
                    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['save', this]}));
              });
 
     d3.select ("#cancel_selection_button")
               .classed ("disabled",false)
               .on ("click", function (e) { // save selection handler
                    $("#selection_name_box").val(current_selection_name);
                    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['cancel', this]}));
              });
                            
    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['new', this]}));
    e.preventDefault    ();
       
});  

function send_click_event_to_menu_objects (e) {
    $("#selection_new, #selection_delete, #selection_rename, #save_selection_name, #selection_name_box, #selection_name_dropdown").get().forEach (
        function (d) {
            d.dispatchEvent (e);
        }
    );
}
   
function update_selection_names (id, skip_rebuild) {

    skip_rebuild = skip_rebuild || false;
    id = id || 0;
    
    
    current_selection_name = selection_set[id];
    current_selection_id = id;
    
    if (!skip_rebuild) {
        d3.selectAll (".selection_set").remove();
    
        d3.select ("#selection_name_dropdown")
          .selectAll (".selection_set")
          .data (selection_set)
          .enter()
          .append ("li")
          .attr ("class", "selection_set")
          .append ("a")
          .attr ("href", "#")
          .text (function (d) { return d;})
          .style ("color", function (d,i) {return color_scheme(i);})
          .on ("click", function (d,i) {update_selection_names (i,true);});
          
    }
      
      
    d3.select ("#selection_name_box")
      .style ("color",  color_scheme(id))
      .property ("value", current_selection_name);
    
    tree.selection_label (selection_set[id]);
}


var width  = 800, //$(container_id).width(),
    height = 600, //$(container_id).height()
    selection_set = ['Foreground'],
    current_selection_name = $("#selection_name_box").val(),
    current_selection_id = 0,
    max_selections       = 10;
    color_scheme = d3.scale.category10(),
    selection_menu_element_action = "phylotree_menu_element_action";
    
var tree = d3.layout.phylotree("body")
    .size([height, width])
    .separation (function (a,b) {return 0;})
    .count_handler (function (count) { 
            $("#selected_branch_counter").text (function (d) {return count[current_selection_name];}); 
            $("#selected_filtered_counter").text (count.tag);
        }
    );
    //.node_span (function (a) {if (a.children && a.children.length) return 1; return isNaN (parseFloat (a["attribute"]) * 100) ? 1 : parseFloat (a["attribute"]) * 100; });
    
var test_string = "(Methanobacterium_bryantii:4.960699e-03[color=red],Methanobacterium_uliginosum:2.250404e-03,((((((((((((((((((((((((Methanocalculus_chunghsingensi:1.777458e-02,Methanocalculus_halotolerans:7.563961e-03)0.84:2.855690e-03,(Methanocalculus_pumilus:3.113870e-03,(Methanocalculus_natronophilus:1.307978e-02,Methanocalculus_taiwanensis:2.571914e-03)0.90:4.361007e-03)0.40:2.364799e-03)1:3.150055e-02,((((Methanocorpusculum_aggregans:6.070826e-04,Methanocorpusculum_parvum:5.907664e-04)0.64:1.212154e-03,Methanocorpusculum_sinense:3.128415e-03)0.49:1.175506e-03,Methanocorpusculum_bavaricum:5.825965e-04)0.47:1.578548e-03,Methanocorpusculum_labreanum:2.657046e-03)1:1.258592e-01)1:7.286843e-02,((((((Methanoculleus_chikugoensis:6.553409e-03,(Methanoculleus_horonobensis:1.298853e-02,(Methanoculleus_hydrogenitrophi:7.872655e-03,Methanoculleus_thermophilus:1.841835e-02)1:1.173181e-02)0.40:2.385314e-03)0.72:2.651314e-03,(Methanoculleus_marisnigri:6.160102e-04,Methanoculleus_submarinus:8.629509e-03)0.99:1.748704e-03)0.75:3.115767e-03,Methanoculleus_sediminis:3.425399e-03)1:1.228973e-02,Methanoculleus_bourgensis:1.602264e-02)0.96:3.662564e-03,Methanoculleus_palmolei:2.023076e-02)0.93:3.473350e-03,Methanoculleus_receptaculi:1.451177e-02)1:1.948267e-02)0.90:1.142837e-02,((((Methanoplanus_petrolearius:1.561911e-03,Methanolacinia_paynteri:3.054229e-03)1:2.433450e-02,Methanomicrobium_mobile:5.495743e-02)0.95:1.209693e-02,(Methanoplanus_endosymbiosus:5.119483e-03,Methanoplanus_limicola:1.223615e-03)1:2.946475e-02)1:1.168793e-02,((((Methanogenium_boonei:7.952861e-03,Methanogenium_marinum:5.974814e-03)0.57:3.387017e-03,Methanogenium_frigidum:6.831131e-03)0.55:2.639124e-03,Methanogenium_cariaci:2.634689e-03)0.57:5.864193e-03,Methanogenium_organophilum:1.426058e-02)1:2.261768e-02)1:3.939006e-02)0.54:6.868698e-03,((Methanofollis_formosanus:1.615237e-02,Methanofollis_aquaemaris:2.189573e-02)1:9.345975e-03,((Methanofollis_liminatans:4.812719e-03,Methanofollis_tationis:9.264958e-04)1:2.389642e-02,Methanofollis_ethanolicus:2.591375e-02)1:6.313209e-03)1:3.396612e-02)0.42:6.843197e-03,((((Methanoregula_boonei:2.543515e-02,Methanoregula_formicica:2.328685e-02)1:3.703720e-02,(Methanolinea_mesophila:2.300103e-02,((Methanospirillum_hungatei:1.578394e-03,Methanospirillum_stamsii:2.715527e-02)1:2.175317e-02,(Methanospirillum_lacunae:2.819598e-02,Methanospirillum_psychrodurum:1.790409e-02)1:2.424051e-02)1:9.460612e-02)0.50:6.248904e-03)1:1.486334e-02,Methanolinea_tarda:3.214515e-02)1:9.984836e-03,Methanosphaerula_palustris:3.444963e-02)1:1.775919e-02)1:1.028248e-01,(((((((Methanimicrococcus_blatticola:1.331681e-01,(((((((Methanosarcina_mazei:6.232483e-04,Methanosarcina_soligelidi:1.417464e-03)1:1.131388e-02,Methanosarcina_horonobensis:2.100787e-03)0.98:5.631188e-03,((Methanosarcina_barkeri:6.700169e-03,(Methanosarcina_spelaei:5.243128e-03,Methanosarcina_vacuolata:2.348099e-03)0.55:2.363216e-03)0.68:3.345776e-03,Methanosarcina_thermophila:1.294162e-02)0.75:4.077111e-03)0.98:4.842418e-03,Methanosarcina_acetivorans:5.729866e-03)0.86:3.254548e-03,Methanosarcina_siciliae:3.786734e-03)1:1.145041e-02,Methanosarcina_lacustris:1.200243e-02)1:1.178864e-02,(Methanosarcina_baltica:3.304907e-02,Methanosarcina_semesiae:2.061152e-02)1:1.572066e-02)1:2.130783e-02)1:1.847567e-02,(((((((Methanolobus_bombayensis:1.789743e-02,Methanolobus_tindarius:5.743855e-03)0.90:3.969776e-03,Methanolobus_vulcani:7.377526e-03)1:7.347685e-03,Methanolobus_profundi:8.344332e-03)1:1.353002e-02,Methanolobus_taylorii:1.375326e-02)1:6.138764e-03,Methanolobus_oregonensis:1.091680e-02)1:6.853748e-03,(Methanolobus_psychrophilus:2.037666e-02,Methanolobus_zinderi:1.692709e-02)0.79:3.970959e-03)1:2.137184e-02,(Methanomethylovorans_hollandic:5.407421e-03,(Methanomethylovorans_thermophi:1.451666e-02,Methanomethylovorans_uponensis:6.758682e-03)0.70:3.827645e-03)1:2.931614e-02)0.57:1.039071e-02)0.22:3.635223e-03,(((Methanohalophilus_euhalobius:8.840827e-03,((Methanohalophilus_halophilus:6.017132e-04,Methanohalophilus_portucalensi:1.397972e-03)0.97:1.442229e-03,Methanohalophilus_mahii:1.337872e-03)0.38:8.832848e-04)1:1.884166e-02,Methanohalophilus_levihalophil:2.395494e-02)1:1.797271e-02,((Methanococcoides_alaskense:3.132970e-03,Methanococcoides_burtonii:6.821607e-03)0.99:8.428074e-03,(Methanococcoides_methylutens:4.109475e-03,Methanococcoides_vulcani:5.079580e-03)0.97:7.012861e-03)1:2.926866e-02)1:1.166752e-02)0.70:9.001381e-03,(Methanohalobium_evestigatum:5.468741e-02,Methanosalsum_zhilinae:2.204273e-02)1:1.708673e-02)1:7.068391e-02,((Methanosaeta_harundinacea:2.165321e-02,Methanosaeta_pelagica:2.374197e-02)1:1.276730e-02,(Methanosaeta_thermophila:5.868726e-02,Methanosaeta_concilii:6.306596e-02)1:2.743990e-02)1:4.822590e-02)0.91:1.892170e-02,Methermicoccus_shengliensis:6.620598e-02)1:6.770345e-02,(Methanocella_arvoryzae:3.564041e-02,(Methanocella_conradii:3.050847e-02,Methanocella_paludicola:2.596836e-02)1:3.843676e-02)1:1.613857e-01)0.98:2.338236e-02)1:8.914739e-02,Methanomassiliicoccus_luminyen:4.015922e-01)1:1.457877e-01,(((((((Methanococcus_maripaludis:5.711687e-02,(Methanococcus_vannielii:2.887432e-02,Methanococcus_voltae:5.290746e-02)0.67:6.478181e-03)1:3.184354e-02,(Methanococcus_aeolicus:4.312713e-02,Methanothermococcus_okinawensi:1.055551e-02)1:2.559150e-02)1:1.370378e-02,Methanothermococcus_thermolith:1.857590e-02)1:7.503847e-02,Methanotorris_formicicus:5.454854e-03)1:1.047731e-02,Methanotorris_igneus:8.330308e-04)1:4.170852e-02,(Methanocaldococcus_villosus:2.552187e-02,(((Methanocaldococcus_fervens:3.610224e-03,Methanocaldococcus_jannaschii:8.905089e-04)0.96:5.150528e-03,Methanocaldococcus_vulcanius:1.308450e-02)1:1.547367e-02,(Methanocaldococcus_indicus:2.449282e-02,Methanocaldococcus_infernus:1.040158e-02)1:1.523718e-02)1:1.076281e-02)1:2.854528e-02)1:9.993807e-02,Methanopyrus_kandleri:1.545788e-01)0.95:2.698779e-02)1:6.840231e-02,(Methanothermus_fervidus:4.997267e-03,Methanothermus_sociabilis:6.254064e-04)1:3.288351e-02)1:8.574960e-02,(Methanothermobacter_crinale:1.033796e-02,Methanothermobacter_tenebrarum:3.318237e-03)1:1.130989e-02)1:2.298174e-02,((((Methanothermobacter_thermautot:5.955961e-04,Methanothermobacter_marburgens:6.035725e-04)1:6.523320e-03,Methanothermobacter_wolfeii:5.984220e-03)0.87:3.146204e-03,((Methanothermobacter_defluvii:7.591966e-03,Methanothermobacter_thermophil:6.794053e-03)0.98:1.658805e-03,Methanothermobacter_thermoflex:2.364812e-03)1:5.085776e-03)0.72:1.517790e-03,Methanobacterium_thermaggregan:1.295157e-03)1:1.298004e-02)1:2.827830e-02,(((((((((((((Methanobrevibacter_millerae:5.795993e-03,(Methanobrevibacter_gottschalki:2.406270e-02,Methanobrevibacter_thaueri:9.063288e-03)0.98:4.460487e-03)1:1.000432e-02,Methanobrevibacter_oralis:4.579192e-02)0.87:3.993949e-03,Methanobrevibacter_smithii:8.702379e-03)1:1.301373e-02,Methanobrevibacter_woesei:1.904664e-02)1:2.567069e-02,(Methanobrevibacter_olleyae:4.828220e-03,Methanobrevibacter_ruminantium:1.319497e-02)1:2.792049e-02)0.92:9.045718e-03,(Methanobrevibacter_boviskorean:2.258522e-02,Methanobrevibacter_wolinii:2.443767e-02)1:3.582117e-02)0.99:1.154428e-02,Methanobrevibacter_acididurans:3.235946e-02)1:1.544590e-02,Methanobrevibacter_arboriphilu:1.568122e-02)0.58:3.295806e-03,Methanobrevibacter_cuticularis:1.001692e-02)1:8.730193e-03,Methanobrevibacter_curvatus:2.860327e-02)0.96:6.853408e-03,Methanobrevibacter_filiformis:2.676650e-02)1:3.933199e-02,Methanobacterium_flexile:6.540810e-03)1:8.371903e-03,(Methanobacterium_alcaliphilum:6.303755e-04,Methanobacterium_movens:3.200933e-03)1:8.670494e-03)1:1.742353e-02)1:1.738495e-02,Methanobacterium_aarhusense:1.863364e-02)1:1.590778e-02,Methanobacterium_congolense:3.053602e-02)0.35:2.933570e-03,(((Methanobacterium_formicicum:3.018585e-03,Methanobacterium_subterraneum:4.983044e-03)0.67:3.147041e-03,Methanobacterium_palustre:1.595481e-02)0.88:9.534133e-03,(Methanobacterium_ferruginis:1.276797e-02,(Methanobacterium_kanagiense:1.410324e-02,Methanobacterium_petrolearium:5.076445e-03)1:1.294363e-02)0.90:6.261332e-03)1:2.017637e-02)0.27:3.544900e-03,(Methanosphaera_cuniculi:2.171837e-02,Methanosphaera_stadtmanae:1.905728e-02)1:1.002445e-01)0.95:9.934035e-03,((Methanobacterium_lacus:1.799902e-02,Methanobacterium_beijingense:2.507474e-02)1:8.704085e-03,Methanobacterium_movilense:1.166656e-02)0.85:7.000854e-03)1:1.113426e-02,Methanobacterium_oryzae:1.030587e-02)1:2.392223e-02,Methanobacterium_ivanovii:6.185214e-04)0.46:1.110837e-03,Methanobacterium_veterum:6.485711e-04)0.28:1.068472e-03,Methanobacterium_espanolae:3.266975e-03)0.44:1.135261e-03,Methanobacterium_arcticum:1.472159e-03)1:4.871280e-03)";
var res = d3.layout.newick_parser( test_string );

var container_id = '#tree_container';
//var test_string = "(a : 0.1, (b : 0.11, (c : 0.12, d : 0.13) : 0.14) : 0.15)";

//window.setInterval (function () {});
   
var svg = d3.select(container_id).append("svg")
    .attr("width", width)
    .attr("height", height);
                    
                

function selection_handler_name_box (e) {
    var name_box = d3.select (this);
     switch (e.detail[0]) {
        case 'save':
        case 'cancel':
            name_box.property ("disabled", true)
                    .style ("color",  color_scheme(current_selection_id));

            break;
        case 'new':
            name_box.property ("disabled", false)
                    .property ("value", "new_selection_name")
                    .style ("color",  color_scheme(selection_set.length));
            break;
        case 'rename':
           name_box.property ("disabled", false);
           break;
    }
    
}

function selection_handler_new (e) {
    var element = d3.select (this);
    $(this).data('tooltip', false);         
    switch (e.detail[0]) {
        case 'save':
        case 'cancel':
            if (selection_set.length == max_selections) {
                element.classed ("disabled", true);
                    $(this).tooltip ({'title' : 'Up to ' + max_selections + ' are allowed', 'placement' : 'left'});
            } else {
                element.classed ("disabled", null);
            }
            break;
        default:
            element.classed ("disabled", true);
            break;
            
    }
}

function selection_handler_rename (e) {
    var element = d3.select (this);
    element.classed ("disabled", (e.detail[0] == "save" || e.detail[0] == "cancel") ? null : true);
}

function selection_handler_save_selection_name (e) {
    var element = d3.select (this);
    element.style ("display", (e.detail[0] == "save" || e.detail[0] == "cancel") ? "none" : null);
}

function selection_handler_name_dropdown (e) {
    var element = d3.select (this).selectAll (".selection_set");
    element.classed ("disabled", (e.detail[0] == "save" || e.detail[0] == "cancel") ? null : true);
}

function selection_handler_delete (e) {
    var element = d3.select (this);
    $(this).tooltip('destroy');         
    switch (e.detail[0]) {
        case 'save':
        case 'cancel':
            if (selection_set.length == 1) {
                element.classed ("disabled", true);
                    $(this).tooltip ({'title' : 'At least one named selection set <br> is required;<br>it can be empty, however', 'placement' : 'bottom', 'html': true});
            } else {
                element.classed ("disabled", null);
            }
            break;
        default:
            element.classed ("disabled", true);
            break;
            
    }}


$( document ).ready( function () {
    default_tree_settings();
    tree(res).svg (svg).layout();
    $("#selection_new").get(0).addEventListener(selection_menu_element_action,selection_handler_new,false);
    $("#selection_rename").get(0).addEventListener(selection_menu_element_action,selection_handler_rename,false);
    $("#selection_delete").get(0).addEventListener(selection_menu_element_action,selection_handler_delete,false);
    $("#selection_delete").get(0).dispatchEvent (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['cancel', null]}));
    $("#selection_name_box").get(0).addEventListener(selection_menu_element_action,selection_handler_name_box,false);
    $("#save_selection_name").get(0).addEventListener(selection_menu_element_action,selection_handler_save_selection_name,false);
    $("#selection_name_dropdown").get(0).addEventListener(selection_menu_element_action,selection_handler_name_dropdown,false);
    update_selection_names();   
});

</script>

</body>
</html>
